name: Fetch subtitles (Bilibili / YouTube)

on:
  workflow_dispatch:
    inputs:
      url:
        description: "B站或YouTube视频链接"
        required: true
        type: string
      langs:
        description: "字幕语言(逗号分隔/可正则)，示例：zh-Hans,zh-Hant,en.*"
        required: false
        default: "zh-Hans,zh-Hant,en.*"
        type: string
      user_agent:
        description: "可选：浏览器UA（遇到风控可配合cookies），留空则不传"
        required: false
        default: ""
        type: string

jobs:
  subs:
    runs-on: ubuntu-latest
    env:
      YTDLP_COOKIES_TXT: ${{ secrets.YTDLP_COOKIES_TXT }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js (JS runtime for yt-dlp)
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install yt-dlp
        run: python -m pip install -U yt-dlp

      - name: Write cookies.txt (optional)
        if: ${{ env.YTDLP_COOKIES_TXT != '' }}
        shell: bash
        run: |
          printf '%s' "$YTDLP_COOKIES_TXT" | tr -d '\r' > cookies.txt
          echo "cookies.txt written"
          
      - name: Install ffmpeg
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          ffmpeg -version

      - name: Download subtitles only
        env:
          URL: ${{ inputs.url }}
          LANGS: ${{ inputs.langs }}
          UA: ${{ inputs.user_agent }}
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p subs

          EXTRA_ARGS=()
          if [ -s cookies.txt ]; then
            EXTRA_ARGS+=(--cookies cookies.txt)
          fi
          if [ -n "${UA:-}" ]; then
            EXTRA_ARGS+=(--user-agent "$UA")
          fi

          # 允许下载 EJS 远程组件（解决 JS challenge 缺格式问题）
          REMOTE_ARGS=(--remote-components ejs:github)

          yt-dlp --js-runtimes node "${REMOTE_ARGS[@]}" "${EXTRA_ARGS[@]}" --list-subs "$URL" || true

          yt-dlp \
            --js-runtimes node \
            "${REMOTE_ARGS[@]}" \
            --skip-download \
            --write-subs \
            --write-auto-subs \
            --sub-langs "$LANGS" \
            --sub-format "vtt/best" \
            --convert-subs "srt" \
            -o "subs/%(title).200s_%(id)s.%(ext)s" \
            "${EXTRA_ARGS[@]}" \
            "$URL"

          ls -la subs

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: subtitles
          path: subs/
